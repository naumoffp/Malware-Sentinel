import hashlib
import itertools
import os
import sys
import time

from connect import client_wrapper_main, remove_lines


def sha256sum(filename):
	with open(filename, 'rb', buffering=0) as f:
		return hashlib.file_digest(f, 'sha256').hexdigest()


@client_wrapper_main
def main(client, file):
	remove_lines(1)
	print("Computing file hash...")
	
	# file_hash = sha256sum(file)

	# try:
	# 	vt_file = client.get_object("/files/{}".format(file_hash))
	# 	remove_lines(1)
	# 	print("Hash found! Computing results...")
	
	# except:
	# 	remove_lines(1)
	# 	print("No hash found, submitting file...")

	print(">> Scanning file <<")
	file_path = os.path.abspath(file)
	with open(file_path, "rb") as f:
		analysis = client.scan_file(f)

	# For the loading bar
	dots = itertools.cycle([".", "..", "..."])
	remove_lines(1)

	while True:
		analysis = client.get_object("/analyses/{}", analysis.id)
		
		remove_lines(1)
		print("Waiting for scan to complete" + next(dots))

		if analysis.status == "completed":
			break

		time.sleep(0.2)
	
	remove_lines(1)
	print("Scan complete!")
	print("\u2500"*40)
	ignore = ["type-unsupported", "confirmed-timeout", "timeout", "failure"]
	padding = max(len(key) for key in analysis.stats.keys()) - 6

	for key, value in analysis.stats.items():
		if key in ignore:
			continue

		print(f"{key}:" + " " * (padding - len(key)) + f" {value}")
		time.sleep(0.05)

	solid_line_character = "\u2500"
	print(solid_line_character*40)


if __name__ == "__main__":
	if len(sys.argv) < 2:
		print("No file specified")
		exit(1)

	print("Starting...")
	main()