import functools
import os
import sys
import time
import vt


def remove_lines(amount):
	""" deletes lines printed previously """

	# character codes to cursor up and erase a line
	cursor_up = "\x1b[1A"
	erase = "\x1b[2K"

	# iterate however many line deletions are requested
	for _ in range(amount):
		sys.stdout.write(cursor_up)
		sys.stdout.write(erase)

	# Wait a small amount of time so log messages can be read
	time.sleep(0.05)


def setup():
	remove_lines(1)
	print("Reading API key from environment")
	api_key = os.environ.get("VT_API_KEY", None)

	if not api_key:
		print("No VT API key found! Please set the VT_API_KEY environment variable.")
		print("Quitting...")
		exit(1)

	file = sys.argv[1]

	if not os.path.isfile(file):
		print("File not found! Please check the path and try again.")
		print("Quitting...")
		exit(1)

	return api_key, file


def client_wrapper_main(func):
	@functools.wraps(func)
	def wrapper():
		client = None
		try:
			remove_lines(1)
			print("Setting up client...")

			api_key, file = setup()
			client = vt.Client(api_key)

			remove_lines(1)
			print("Client setup complete...")

			return func(client, file)

		except Exception as e:
			print(f"Error occurred: {e}")

		finally:
			if client:
				client.close()

	return wrapper
